

<!-- System diagnostic -->
<script>

function clearStorageEn() {
  if (window.localStorage) {
    localStorage.clear();
  }
  var msg = 'Local personal information deleted!' +
    '\nThe page will be reloaded...' +
    '\n\n(if this is an error, close the page and relaunch it from within Moodle).';
  if (window.self !== window.parent) {
    parent.alert(msg);
  } else {
    window.alert(msg);
  }
  window.location.href=window.location.href;
}

function clearStorageFr() {
  if (window.localStorage) {
    localStorage.clear();
  }
  var msg = 'Informations personnelles locales effacees !' +
    '\nLa page va etre rechargee...' +
    "\n\n(s'il s'agit d'une fausse manoeuvre, fermer la page et relancez-la depuis Moodle).";
  if (window.self !== window.parent) {
    parent.alert(msg);
  } else {
    window.alert(msg);
  }
  window.location.href=window.location.href;
}

function diagnoseSystemFr() {
  var container = document.getElementById('diagnostic');
  if (container === null) {
    return;
  }
  var content = "";

  if (!window.localStorage) {
    content = content + "<p>Vous &ecirc;tes&nbsp;:</p>\n<ul>";
    content = content + "\n<li>Anonyme sur ce site (stockage local indisponible).</li>";
    content = content + "\n<li>Le contenu <b>n'est pas</b> contextualis&eacute; par rapport &agrave; un cours en particulier.</li>";
    content = content + "\n<li>Le r&eacute;sultat de certains exercices <b>ne sera pas enregistr&eacute;</b>.</li>";
    content = content + "\n</ul>";
    content = content + "\n<p>Si vous n'&ecirc;tes <i>pas</i> un &eacute;tudiant qui suit un cours lié à ce mat&eacute;riel p&eacute;dagogique, c'est normal, vous pouvez continuer votre visite... <b>Bienvenue&nbsp;!</b></p>";
    content = content + "\n<p>En revanche, si votre cours n&eacute;cessite que vous soyez d&ucirc;ment enregistr&eacute;, alors fermez cette page et relancer-l&agrave; depuis le syst&egrave;me d'apprentissage en ligne de votre Universit&eacute; (Moodle, ...). Si ce message se reproduit, contactez vos enseignants.</p>";

  } else {
    // Explore the content of the storage
    // Students are recognized by iemail (institutional email, or (local) email)
    // but possibly, their login could be used too
    var login = localStorage.getItem('login');
    if (login === null) {
      login = '';
    }
    var email = localStorage.getItem('email');
    if (email === null) {
      email = '';
    }
    var iemail = localStorage.getItem('iemail');
    if (iemail === null) {
      iemail = '';
    }
    // Compare both emails, if they are different, display both of them
    if (email != iemail && iemail != '') {
      email = email + '</u> (email institutionnel : <u>' + iemail + ')';
    }

    // Construct an identification string
    content = content + "<p><b>Le contenu de ce cours est contextuel.</b> V&eacute;rifiez les informations suivantes, s'il-vous-plait&nbsp;:</p>\n<ul>";

    var registered = false;
    if (email == '' && login == '') {
      // Not registered
      content = content + "\n<li><u>Vous &ecirc;tes anonyme sur ce site.</u> <b>Votre progression dans les exercices ne sera pas enregistr&eacute;e.</b></li>";

    } else {
      // Registered user
      registered = true;
      if (login != '') {
        content = content + "\n<li>Login&nbsp;: <u>" + login + "</u></li>";
      }
      if (email != '') {
        content = content + "\n<li>Email&nbsp;: <u>" + email + "</u></li>";
      }
      content = content + "\n<b>Votre progression dans les exercices sera enregistr&eacute;e sous cette r&eacute;f&eacute;rence.</b>";
    }

    // institution and icourse possibly change the content. So, must be checked!
    var context = false;
    var institution = localStorage.getItem('institution');
    if (institution == null || institution == '') {
      institution = 'ind&eacute;termin&eacute;e';
    } else {
      context = true;
    }
    var icourse = localStorage.getItem('icourse');
    if (icourse == null || icourse == '') {
      icourse = 'ind&eacute;termin&eacute;';
    } else {
      context = true;
      var ictitle = localStorage.getItem('ictitle');
      if (ictitle != null && ictitle != '') {
        icourse = ictitle + ' (' + icourse + ')';
      }
    }
    content = content + "\n<li>Cours&nbsp;: <u>" + icourse + "</u></li>";
    content = content + "\n<li>Institution&nbsp;: <u>" + institution + "</u></li>";
    content = content + "\n</ul>";
    if (context) {
      content = content + "<p><b>Le contenu sera adapt&eacute; en fonction de ce contexte.</b> Vérifiez qu'il est correct, sinon fermez cette page et relancer-l&agrave; depuis le syst&egrave;me d'apprentissage en ligne de votre Universit&eacute; (Moodle, ...). Si ce message se reproduit, contactez vos enseignants.</p>";
    } else {// No context
      content = content + "<p><b>N'&eacute;tant dans aucun contexte de cours particulier, vous n'aurez acc&egrave;s qu'&agrave un contenu g&eacute;n&eacute;raliste.</b> Si c'est ce que vous souhaitez... bienvenue&nbsp;! Sinon, fermez cette page et relancer-l&agrave; depuis le syst&egrave;me d'apprentissage en ligne de votre Universit&eacute; (Moodle, ...). Si ce message se reproduit, contactez vos enseignants.</p>";
    }

    // If registered user and/or special context, offer to reset it
    if (registered || context) {
      content = content + "\n<p>Pour explorer ces pages de mani&egrave;re anonyme et n'enregistrer aucune activit&eacute;, vous pouvez &eacute;liminez vos informations personnelles en cliquant sur le bouton juste ci-dessous.</p>";
      content = content + "<button onclick=\"clearStorageFr()\">Effacer mes donn&eacute;es personnelles</button>";
    }
    // Those variables are possibly defined, but they are not tested here (yet)
    //var displayname = localStorage.getItem('displayname');
    //var firstname = localStorage.getItem('firstname');
    //var lastname = localStorage.getItem('lastname');
    //var ifirstname = localStorage.getItem('ifirstname');
    //var ilastname = localStorage.getItem('ilastname');
    //var iid = localStorage.getItem('iid');
    //var iurl = localStorage.getItem('iurl');
    //var iref = localStorage.getItem('iref');
  }

  container.innerHTML = content;
}
</script>

